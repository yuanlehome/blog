---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import PostList from '../../components/PostList.astro';
import { getPublishedPosts } from '../../lib/content/posts';
import { normalizeBase } from '../../lib/slug';
import { getPaginationPages } from '../../lib/ui/pagination';

export async function getStaticPaths() {
  const PAGE_SIZE = 5;
  const posts = await getPublishedPosts();
  const totalPages = Math.max(1, Math.ceil(posts.length / PAGE_SIZE));
  return Array.from({ length: totalPages }, (_, i) => {
    const page = i + 1;
    const slice = posts.slice(i * PAGE_SIZE, (i + 1) * PAGE_SIZE);
    return { params: { page: String(page) }, props: { slice, page, totalPages } };
  });
}

const { slice, page, totalPages } = Astro.props;
const BASE = normalizeBase(import.meta.env.BASE_URL);
const paginationPages = getPaginationPages({ currentPage: page, totalPages, windowSize: 5 });
---

<Layout title={`Page ${page} | Yuanle Liu‘s Blog`}>
  <Header />
  <main class="container mx-auto px-4 py-8 max-w-4xl">
    <div class="flex flex-col gap-2 mb-6">
      <h2 class="text-2xl font-bold">Posts</h2>
      <p class="text-sm text-gray-500">Page {page} / {totalPages}</p>
    </div>
    <PostList posts={slice} />

    <nav class="flex justify-center items-center gap-2 mt-10" aria-label="Pagination">
      {
        page > 1 ? (
          <a
            href={page === 2 ? `${BASE}` : `${BASE}page/${page - 1}/`}
            class="px-3 py-2 rounded bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
            aria-label="Go to previous page"
          >
            ← Newer
          </a>
        ) : (
          <span
            class="px-3 py-2 rounded bg-gray-100 dark:bg-gray-800 opacity-50 cursor-not-allowed"
            aria-disabled="true"
            aria-label="No previous page"
          >
            ← Newer
          </span>
        )
      }

      <div class="flex gap-1 md:gap-2" role="list">
        {
          paginationPages.map((pageNum) =>
            pageNum === 'ellipsis' ? (
              <span class="px-2 md:px-3 py-2 text-gray-500 dark:text-gray-400" aria-hidden="true">
                …
              </span>
            ) : pageNum === page ? (
              <span
                class="px-3 py-2 rounded bg-blue-500 text-white font-semibold"
                aria-current="page"
                aria-label={`Page ${pageNum}, current page`}
              >
                {pageNum}
              </span>
            ) : (
              <a
                href={pageNum === 1 ? `${BASE}` : `${BASE}page/${pageNum}/`}
                class="px-3 py-2 rounded bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
                aria-label={`Go to page ${pageNum}`}
              >
                {pageNum}
              </a>
            ),
          )
        }
      </div>

      {
        page < totalPages ? (
          <a
            href={`${BASE}page/${page + 1}/`}
            class="px-3 py-2 rounded bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
            aria-label="Go to next page"
          >
            Older →
          </a>
        ) : (
          <span
            class="px-3 py-2 rounded bg-gray-100 dark:bg-gray-800 opacity-50 cursor-not-allowed"
            aria-disabled="true"
            aria-label="No next page"
          >
            Older →
          </span>
        )
      }
    </nav>
  </main>
  <Footer />
</Layout>
