---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { getReadingTime } from '../lib/content/readingTime';
import { resolveAssetUrl } from '../lib/site/assetUrl';
import TableOfContents from '../components/TableOfContents.astro';
import MobileToc from '../components/MobileToc.astro';
import PrevNext from '../components/PrevNext.astro';
import RelatedPosts from '../components/RelatedPosts.astro';
import { findPrevNext, findRelated, getPublishedPosts } from '../lib/content/posts';
import Giscus from '../components/Giscus.astro';
import ReadingProgress from '../components/ReadingProgress.astro';
import FloatingActionStack from '../components/FloatingActionStack.astro';
import { getDisplayDates } from '../lib/content/dates';
import { getLayoutConfig } from '../config/loaders';
import { alignToTextClass, alignToJustifyClass, alignToItemsClass } from '../lib/ui/alignment';
import Tag from '../components/Tag.astro';
import { buildTagIndex } from '../lib/content/tags';

export async function getStaticPaths() {
  const posts = await getPublishedPosts();
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post, all: posts },
  }));
}

const { post, all } = Astro.props;
const { Content, headings } = await post.render();
const tocHeadings = headings.filter((heading) => heading.depth >= 2 && heading.depth <= 3);
const hasToc = tocHeadings.length > 0;
const stats = getReadingTime(post.body);
const { prev, next } = findPrevNext(all, post.slug);
const related = findRelated(all, post);
const commentsEnabled = post.data.comments ?? true;
const dates = getDisplayDates(post.data);
const hasCover = Boolean(post.data.cover);
const postTags = post.data.tags || [];
const { tagMap } = buildTagIndex(all);
const tagSlugs = postTags
  .map((tagName) => {
    // Find the slug for this tag name
    const entry = Object.entries(tagMap).find(([_, data]) => data.name === tagName);
    return entry ? { name: tagName, slug: entry[0] } : null;
  })
  .filter(Boolean) as { name: string; slug: string }[];

// Get post meta alignment from config
const layoutConfig = getLayoutConfig();
const postMetaAlign = layoutConfig.alignment.postMetaAlign;
const metaTextClass = alignToTextClass(postMetaAlign);
const metaJustifyClass = alignToJustifyClass(postMetaAlign);

// Get TOC position from config
const tocPosition = layoutConfig.toc.position;
---

<Layout title={post.data.title} image={resolveAssetUrl(post.data.cover)}>
  <ReadingProgress />
  <Header />
  <main class="container mx-auto px-4 py-8 max-w-6xl">
    <div
      class={`flex flex-col gap-6 ${
        hasToc && tocPosition === 'left'
          ? 'lg:grid lg:grid-cols-[280px_minmax(0,1fr)] lg:items-start lg:gap-12'
          : hasToc && tocPosition === 'right'
            ? 'lg:grid lg:grid-cols-[minmax(0,1fr)_280px] lg:items-start lg:gap-12'
            : 'lg:grid lg:grid-cols-1'
      }`}
      data-post-layout
    >
      {
        hasToc && tocPosition === 'left' && (
          <TableOfContents headings={tocHeadings} position="left" />
        )
      }
      <article class="prose dark:prose-invert max-w-none prose-img:rounded-xl min-w-0" data-article>
        <header class="mb-8 not-prose">
          <div
            class={`flex flex-col gap-6 ${
              hasCover
                ? 'md:grid md:grid-cols-[minmax(0,1fr)_220px] md:items-start md:gap-8'
                : 'md:grid md:grid-cols-1'
            }`}
          >
            <div class={`flex flex-col gap-4 ${hasCover ? 'md:h-full' : ''}`}>
              <h1 class={`text-3xl md:text-4xl font-bold leading-tight ${metaTextClass}`}>
                {post.data.title}
              </h1>
              <div
                class={`text-zinc-500 text-sm flex ${alignToItemsClass(postMetaAlign)} ${metaJustifyClass} gap-3 flex-wrap ${
                  hasCover ? 'md:mt-auto' : ''
                }`}
              >
                {
                  dates.publishedLabel && (
                    <time
                      class="flex items-center gap-1"
                      datetime={dates.published?.toISOString()}
                      title={`å‘å¸ƒäº ${dates.publishedLabel}`}
                    >
                      <span aria-hidden="true">ğŸ“…</span>
                      <span>
                        å‘å¸ƒäº <span class="font-medium">{dates.publishedLabel}</span>
                      </span>
                    </time>
                  )
                }
                {dates.publishedLabel && dates.updatedLabel && <span aria-hidden="true">Â·</span>}
                {
                  dates.updatedLabel && (
                    <time
                      class="flex items-center gap-1"
                      datetime={dates.updated?.toISOString()}
                      title={`æ›´æ–°äº ${dates.updatedLabel}`}
                    >
                      <span aria-hidden="true">ğŸ”„</span>
                      <span>
                        æ›´æ–°äº <span class="font-medium">{dates.updatedLabel}</span>
                      </span>
                    </time>
                  )
                }
                <div class="flex items-center gap-1">
                  <span aria-hidden="true">âœï¸</span>
                  {stats.wordCount} å­—
                </div>
                <div class="flex items-center gap-1" title={`${stats.wordCount} words`}>
                  <span aria-hidden="true">â±ï¸</span>
                  {stats.text}
                </div>
              </div>

              {
                tagSlugs.length > 0 && (
                  <div class="flex flex-wrap gap-2 items-center" data-testid="post-tags">
                    <span class="text-zinc-500 text-sm flex items-center gap-1">
                      <span aria-hidden="true">ğŸ·ï¸</span>
                      <span>æ ‡ç­¾ï¼š</span>
                    </span>
                    {tagSlugs.map((tag) => (
                      <Tag name={tag.name} slug={tag.slug} size="sm" />
                    ))}
                  </div>
                )
              }
            </div>

            {
              hasCover && (
                <figure
                  class="hidden md:block md:justify-self-end overflow-hidden rounded-xl border border-zinc-200/80 shadow-md dark:border-zinc-800/80 w-full max-w-[320px] md:max-w-[220px] md:min-w-[160px]"
                  data-post-cover
                >
                  <img
                    src={resolveAssetUrl(post.data.cover)}
                    alt={post.data.title}
                    class="aspect-[4/3] w-full object-cover transition duration-200"
                    loading="eager"
                    decoding="async"
                  />
                </figure>
              )
            }

            {
              post.data.source_url && (
                <div
                  class={`w-full rounded-lg border border-sky-200 bg-sky-50 px-4 py-3 dark:border-sky-900 dark:bg-sky-950 ${
                    hasCover ? 'md:col-span-2' : ''
                  }`}
                >
                  <p class="text-sm text-zinc-700 dark:text-zinc-300 break-words">
                    <span class="font-semibold">ğŸ“ è½¬è½½ / å¼•ç”¨æ¥æºï¼š</span>
                    {post.data.source_author && (
                      <span>
                        ä½œè€… <span class="font-medium">{post.data.source_author}</span> Â·{' '}
                      </span>
                    )}
                    <a
                      href={post.data.source_url}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-sky-600 underline hover:text-sky-700 dark:text-sky-400 dark:hover:text-sky-300"
                    >
                      æŸ¥çœ‹åŸæ–‡
                    </a>
                  </p>
                </div>
              )
            }
          </div>
        </header>

        <Content />

        <PrevNext prev={prev} next={next} />
        <RelatedPosts posts={related} />
        {commentsEnabled && <Giscus lang="zh-CN" loading="lazy" />}
        <div id="page-bottom-anchor" aria-hidden="true" style="height: 1px;"></div>
      </article>
      {
        hasToc && tocPosition === 'right' && (
          <TableOfContents headings={tocHeadings} position="right" />
        )
      }
    </div>
    {hasToc && <MobileToc headings={tocHeadings} showTrigger={false} />}
    <FloatingActionStack
      enableToc={hasToc}
      enableTop={true}
      enableBottom={true}
      targetSelector="[data-article]"
    />
  </main>
  <Footer />
</Layout>
