---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { getReadingTime } from '../utils/readingTime';
import TableOfContents from '../components/TableOfContents.astro';
import MobileToc from '../components/MobileToc.astro';
import PrevNext from '../components/PrevNext.astro';
import RelatedPosts from '../components/RelatedPosts.astro';
import { findPrevNext, findRelated, getPublishedPosts } from '../utils/posts';
import Giscus from '../components/Giscus.astro';
import ReadingProgress from '../components/ReadingProgress.astro';
import FloatingActionStack from '../components/FloatingActionStack.astro';

export async function getStaticPaths() {
  const posts = await getPublishedPosts();
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post, all: posts },
  }));
}

const { post, all } = Astro.props;
const { Content, headings } = await post.render();
const stats = getReadingTime(post.body);
const { prev, next } = findPrevNext(all, post.slug);
const related = findRelated(all, post);
const commentsEnabled = post.data.comments ?? true;

const BASE = import.meta.env.BASE_URL.endsWith('/')
  ? import.meta.env.BASE_URL
  : import.meta.env.BASE_URL + '/';
---

<Layout title={post.data.title} image={`${BASE}${post.data.cover.replace(/^\//, '')}`}>
  <ReadingProgress />
  <Header />
  <main class="container mx-auto px-4 py-8 max-w-6xl">
    <div
      class="flex flex-col gap-6 lg:grid lg:grid-cols-[minmax(0,1fr)_18rem] lg:items-start lg:gap-12"
      data-post-layout
    >
      <article class="prose dark:prose-invert max-w-none prose-img:rounded-xl min-w-0" data-article>
        <header class="mb-8 not-prose">
          {
            post.data.cover && (
              <img
                src={`${BASE}${post.data.cover.replace(/^\//, '')}`}
                alt={post.data.title}
                class="w-full h-64 object-cover rounded-xl mb-6"
              />
            )
          }
          <h1 class="text-3xl md:text-4xl font-bold mb-4">{post.data.title}</h1>
          <div class="text-gray-500 text-sm flex items-center gap-4 flex-wrap">
            <time class="flex items-center gap-1">
              <span>ğŸ“…</span>
              {post.data.date.toLocaleDateString()}
            </time>
            <div class="flex items-center gap-1">
              <span>âœï¸</span>
              {stats.wordCount} å­—
            </div>
            <div class="flex items-center gap-1" title={`${stats.wordCount} words`}>
              <span>â±ï¸</span>
              {stats.text}
            </div>
          </div>
          {
            post.data.source_url && (
              <div class="mt-4 rounded-lg border border-blue-200 bg-blue-50 px-4 py-3 dark:border-blue-900 dark:bg-blue-950">
                <p class="text-sm text-gray-700 dark:text-gray-300">
                  <span class="font-semibold">ğŸ“ è½¬è½½ / å¼•ç”¨æ¥æºï¼š</span>
                  {post.data.source_author && (
                    <span>
                      ä½œè€… <span class="font-medium">{post.data.source_author}</span> Â·{' '}
                    </span>
                  )}
                  <a
                    href={post.data.source_url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-blue-600 underline hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300"
                  >
                    æŸ¥çœ‹åŸæ–‡
                  </a>
                </p>
              </div>
            )
          }
        </header>

        <Content />

        <PrevNext prev={prev} next={next} />
        <RelatedPosts posts={related} />
        {commentsEnabled && <Giscus lang="zh-CN" loading="lazy" />}
      </article>
      <TableOfContents headings={headings} />
    </div>
    <MobileToc headings={headings} showTrigger={false} />
    <FloatingActionStack
      enableToc={headings.length > 0}
      enableTop={true}
      enableBottom={true}
      targetSelector="[data-article]"
    />
  </main>
  <Footer />
</Layout>
