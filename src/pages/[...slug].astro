---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { getReadingTime } from '../utils/readingTime';
import TableOfContents from '../components/TableOfContents.astro';
import PrevNext from '../components/PrevNext.astro';
import RelatedPosts from '../components/RelatedPosts.astro';
import { findPrevNext, findRelated, getPublishedPosts } from '../utils/posts';
import Giscus from '../components/Giscus.astro';
import ReadingProgress from '../components/ReadingProgress.astro';

export async function getStaticPaths() {
  const posts = await getPublishedPosts();
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post, all: posts },
  }));
}

const { post, all } = Astro.props;
const { Content, headings } = await post.render();
const stats = getReadingTime(post.body);
const { prev, next } = findPrevNext(all, post.slug);
const related = findRelated(all, post);
const commentsEnabled = post.data.comments ?? true;
---

<Layout title={post.data.title} image={post.data.cover}>
  <ReadingProgress />
  <Header />
  <main class="container mx-auto px-4 py-8 max-w-6xl">
    <div class="flex gap-8">
      <TableOfContents headings={headings} />

      <article class="prose dark:prose-invert max-w-none prose-img:rounded-xl flex-1 min-w-0" data-article>
        <header class="mb-8 not-prose">
          {post.data.cover && (
            <img src={post.data.cover} alt={post.data.title} class="w-full h-64 object-cover rounded-xl mb-6" />
          )}
          <h1 class="text-3xl md:text-4xl font-bold mb-4">{post.data.title}</h1>
          <div class="text-gray-500 text-sm flex items-center gap-4 flex-wrap">
            <time class="flex items-center gap-1">
              <span>üìÖ</span>
              {post.data.date.toLocaleDateString()}
            </time>
            <div class="flex items-center gap-1">
              <span>‚úçÔ∏è</span>
              {stats.wordCount} Â≠ó
            </div>
            <div class="flex items-center gap-1" title={`${stats.wordCount} words`}>
              <span>‚è±Ô∏è</span>
              {stats.text}
            </div>
          </div>
        </header>

        <Content />

        <PrevNext prev={prev} next={next} />
        <RelatedPosts posts={related} />
        {commentsEnabled && <Giscus lang="zh-CN" loading="lazy" />}
      </article>
    </div>
  </main>
  <Footer />
</Layout>
