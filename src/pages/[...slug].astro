---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { getReadingTime } from '../utils/readingTime';
import TableOfContents from '../components/TableOfContents.astro';
import PrevNext from '../components/PrevNext.astro';
import RelatedPosts from '../components/RelatedPosts.astro';
import { findPrevNext, findRelated, getPublishedPosts } from '../utils/posts';
import Giscus from '../components/Giscus.astro';
import ReadingProgress from '../components/ReadingProgress.astro';

export async function getStaticPaths() {
  const posts = await getPublishedPosts();
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post, all: posts },
  }));
}

const { post, all } = Astro.props;
const { Content, headings } = await post.render();
const stats = getReadingTime(post.body);
const { prev, next } = findPrevNext(all, post.slug);
const related = findRelated(all, post);
const commentsEnabled = post.data.comments ?? true;
const tags = post.data.tags ?? [];
---

<Layout title={post.data.title} image={post.data.cover}>
  <ReadingProgress />
  <Header />
  <main class="container-narrow py-12">
    <div class="grid gap-10 xl:grid-cols-[1fr,18rem]">
      <article class="prose dark:prose-invert max-w-none prose-img:rounded-xl flex-1 min-w-0" data-article>
        <header class="mb-10 not-prose space-y-4">
          <p class="text-xs uppercase tracking-[0.25em] text-gray-500 dark:text-gray-400">Long-form note</p>
          <h1 class="text-3xl md:text-4xl font-semibold leading-tight tracking-tight text-gray-900 dark:text-gray-50">
            {post.data.title}
          </h1>
          <div class="flex flex-wrap items-center gap-3 text-sm text-gray-600 dark:text-gray-300">
            <span class="meta-pill">üìÖ {post.data.date.toLocaleDateString()}</span>
            <span class="meta-pill">‚è±Ô∏è {stats.text}</span>
            <span class="meta-pill">‚úçÔ∏è {stats.wordCount} Â≠ó</span>
            {tags.length > 0 && (
              <div class="flex flex-wrap gap-2">
                {tags.map((tag) => (
                  <span class="meta-pill">#{tag}</span>
                ))}
              </div>
            )}
          </div>
          {post.data.cover && (
            <img src={post.data.cover} alt={post.data.title} class="w-full max-h-[22rem] object-cover rounded-2xl shadow-lg" />
          )}
        </header>

        <div class="rounded-2xl border border-gray-200/80 bg-white/80 px-6 py-8 shadow-sm ring-1 ring-black/5 dark:border-gray-800/70 dark:bg-gray-900/70">
          <Content />
        </div>

        <div class="mt-10 space-y-10 not-prose">
          <PrevNext prev={prev} next={next} />
          <RelatedPosts posts={related} />
          {commentsEnabled && <Giscus lang="zh-CN" loading="lazy" />}
        </div>
      </article>

      <TableOfContents headings={headings} />
    </div>
  </main>
  <Footer />
</Layout>
