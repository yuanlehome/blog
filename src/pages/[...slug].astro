---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { getReadingTime } from '../utils/readingTime';
import { resolveAssetUrl } from '../utils/assetUrl';
import TableOfContents from '../components/TableOfContents.astro';
import MobileToc from '../components/MobileToc.astro';
import PrevNext from '../components/PrevNext.astro';
import RelatedPosts from '../components/RelatedPosts.astro';
import { findPrevNext, findRelated, getPublishedPosts } from '../utils/posts';
import Giscus from '../components/Giscus.astro';
import ReadingProgress from '../components/ReadingProgress.astro';
import FloatingActionStack from '../components/FloatingActionStack.astro';
import { getDisplayDates } from '../utils/dates';

export async function getStaticPaths() {
  const posts = await getPublishedPosts();
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post, all: posts },
  }));
}

const { post, all } = Astro.props;
const { Content, headings } = await post.render();
const stats = getReadingTime(post.body);
const { prev, next } = findPrevNext(all, post.slug);
const related = findRelated(all, post);
const commentsEnabled = post.data.comments ?? true;
const dates = getDisplayDates(post.data);
const hasCover = Boolean(post.data.cover);
---

<Layout title={post.data.title} image={resolveAssetUrl(post.data.cover)}>
  <ReadingProgress />
  <Header />
  <main class="container mx-auto px-4 py-8 max-w-6xl">
    <div
      class="flex flex-col gap-6 lg:grid lg:grid-cols-[minmax(0,1fr)_18rem] lg:items-start lg:gap-12"
      data-post-layout
    >
      <article class="prose dark:prose-invert max-w-none prose-img:rounded-xl min-w-0" data-article>
        <header class="mb-8 not-prose">
          <div
            class={`grid gap-6 ${
              hasCover ? 'md:grid-cols-[minmax(0,1fr)_220px] md:items-start md:gap-8' : ''
            }`}
          >
            <div class={`flex flex-col gap-4 ${hasCover ? 'md:h-full' : ''}`}>
              <h1 class="text-3xl md:text-4xl font-bold leading-tight">{post.data.title}</h1>
              <div
                class={`text-gray-500 text-sm flex items-center gap-3 flex-wrap ${
                  hasCover ? 'md:mt-auto' : ''
                }`}
              >
                {
                  dates.publishedLabel && (
                    <time
                      class="flex items-center gap-1"
                      datetime={dates.published?.toISOString()}
                      title={`å‘å¸ƒäº ${dates.publishedLabel}`}
                    >
                      <span aria-hidden="true">ğŸ“…</span>
                      <span>
                        å‘å¸ƒäº <span class="font-medium">{dates.publishedLabel}</span>
                      </span>
                    </time>
                  )
                }
                {dates.publishedLabel && dates.updatedLabel && <span aria-hidden="true">Â·</span>}
                {
                  dates.updatedLabel && (
                    <time
                      class="flex items-center gap-1"
                      datetime={dates.updated?.toISOString()}
                      title={`æ›´æ–°äº ${dates.updatedLabel}`}
                    >
                      <span aria-hidden="true">ğŸ”„</span>
                      <span>
                        æ›´æ–°äº <span class="font-medium">{dates.updatedLabel}</span>
                      </span>
                    </time>
                  )
                }
                <div class="flex items-center gap-1">
                  <span aria-hidden="true">âœï¸</span>
                  {stats.wordCount} å­—
                </div>
                <div class="flex items-center gap-1" title={`${stats.wordCount} words`}>
                  <span aria-hidden="true">â±ï¸</span>
                  {stats.text}
                </div>
              </div>
            </div>

            {
              hasCover && (
                <figure class="md:justify-self-end overflow-hidden rounded-xl border border-gray-200/80 shadow-md dark:border-gray-800/80 w-full max-w-[320px] md:max-w-[220px] md:min-w-[160px]">
                  <img
                    src={resolveAssetUrl(post.data.cover)}
                    alt={post.data.title}
                    class="aspect-[4/3] w-full object-cover transition duration-200"
                    loading="eager"
                    decoding="async"
                  />
                </figure>
              )
            }

            {
              post.data.source_url && (
                <div class="w-full rounded-lg border border-blue-200 bg-blue-50 px-5 py-3 dark:border-blue-900 dark:bg-blue-950 md:col-span-2">
                  <p class="text-sm text-gray-700 dark:text-gray-300 break-words">
                    <span class="font-semibold">ğŸ“ è½¬è½½ / å¼•ç”¨æ¥æºï¼š</span>
                    {post.data.source_author && (
                      <span>
                        ä½œè€… <span class="font-medium">{post.data.source_author}</span> Â·{' '}
                      </span>
                    )}
                    <a
                      href={post.data.source_url}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-blue-600 underline hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300"
                    >
                      æŸ¥çœ‹åŸæ–‡
                    </a>
                  </p>
                </div>
              )
            }
          </div>
        </header>

        <Content />

        <PrevNext prev={prev} next={next} />
        <RelatedPosts posts={related} />
        {commentsEnabled && <Giscus lang="zh-CN" loading="lazy" />}
      </article>
      <TableOfContents headings={headings} />
    </div>
    <MobileToc headings={headings} showTrigger={false} />
    <FloatingActionStack
      enableToc={headings.length > 0}
      enableTop={true}
      enableBottom={true}
      targetSelector="[data-article]"
    />
  </main>
  <Footer />
</Layout>
