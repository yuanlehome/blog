---
const BASE = import.meta.env.BASE_URL.endsWith('/') ? import.meta.env.BASE_URL : import.meta.env.BASE_URL + '/';
---
<header class="sticky top-0 z-20 backdrop-blur bg-white/80 dark:bg-gray-900/70 border-b border-gray-200/70 dark:border-gray-800/60">
  <div class="container-narrow flex items-center justify-between py-4">
    <div class="flex items-center gap-3">
      <span class="h-9 w-9 rounded-lg bg-gradient-to-br from-blue-500/80 via-blue-500/70 to-slate-900 shadow-md" aria-hidden="true"></span>
      <div class="leading-tight">
        <a href={BASE} class="text-lg font-semibold tracking-tight text-gray-900 dark:text-gray-50 hover:text-blue-600 dark:hover:text-blue-300">
          Yuanle Liu
        </a>
        <p class="text-xs text-gray-500 dark:text-gray-400">Systems | Infra | Reasoning Notes</p>
      </div>
    </div>
    <nav class="flex items-center gap-3 text-sm font-medium">
      <a href={BASE} class="rounded-md px-3 py-2 text-gray-700 hover:text-blue-700 hover:bg-blue-50 dark:text-gray-200 dark:hover:text-blue-200 dark:hover:bg-blue-900/40">Home</a>
      <a href={`${BASE}archive/`} class="rounded-md px-3 py-2 text-gray-700 hover:text-blue-700 hover:bg-blue-50 dark:text-gray-200 dark:hover:text-blue-200 dark:hover:bg-blue-900/40">Archive</a>
      <a href={`${BASE}about/`} class="rounded-md px-3 py-2 text-gray-700 hover:text-blue-700 hover:bg-blue-50 dark:text-gray-200 dark:hover:text-blue-200 dark:hover:bg-blue-900/40">About</a>
      <a href={`${BASE}rss.xml`} class="rounded-md px-3 py-2 text-gray-700 hover:text-blue-700 hover:bg-blue-50 dark:text-gray-200 dark:hover:text-blue-200 dark:hover:bg-blue-900/40">RSS</a>
      <button
        id="theme-toggle"
        class="inline-flex items-center gap-2 rounded-md px-2.5 py-2 text-gray-700 ring-1 ring-transparent transition hover:text-blue-700 hover:ring-blue-200 dark:text-gray-200 dark:hover:text-blue-200 dark:hover:ring-blue-800"
        aria-label="Toggle theme"
      >
        <span class="text-lg" aria-hidden="true">ðŸŒ“</span>
        <span class="sr-only">Toggle theme</span>
      </button>
    </nav>
  </div>
</header>

<script>
  const storageKey = "theme";
  const order: Array<"light" | "dark"> = ["light", "dark"];

  const getPreference = (): "light" | "dark" => {
    try {
      const value = localStorage.getItem(storageKey);
      if (value === "light" || value === "dark") return value;
    } catch (error) {
      console.warn("Unable to read theme preference:", error);
    }
    return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
  };

  const getResolvedTheme = (): "light" | "dark" =>
    document.documentElement.classList.contains("dark") ? "dark" : "light";

  const iconFor = (preference: "light" | "dark") => (preference === "dark" ? "ðŸŒ™" : "â˜€ï¸");

  const labelFor = (preference: "light" | "dark") => (preference === "dark" ? "Dark" : "Light");

  const render = (preference: "light" | "dark", resolvedOverride?: "light" | "dark") => {
    const button = document.getElementById("theme-toggle");
    if (!button) return;
    const resolved: "light" | "dark" = resolvedOverride ?? getResolvedTheme();
    const icon = iconFor(resolved);
    const label = labelFor(resolved);
    (button as HTMLElement).dataset.theme = preference;
    button.querySelector('span[aria-hidden="true"]')!.textContent = icon;
    button.setAttribute("aria-label", `Toggle theme (current: ${label})`);
  };

  declare global {
    interface Window {
      __setTheme?: (preference: "light" | "dark") => void;
    }
  }

  const applyPreference = (preference: "light" | "dark") => {
    if (typeof window.__setTheme === "function") {
      window.__setTheme?.(preference);
      return;
    }

    const resolved: "light" | "dark" = preference === "dark" ? "dark" : "light";
    document.documentElement.classList.toggle("dark", resolved === "dark");
    try {
      localStorage.setItem(storageKey, preference);
    } catch (error) {
      console.warn("Unable to persist theme preference:", error);
    }
    window.dispatchEvent(new CustomEvent("themechange", { detail: { theme: preference, resolved } }));
  };

  const handleToggleClick = () => {
    const current = getPreference();
    const next = order[(order.indexOf(current) + 1) % order.length];
    applyPreference(next);
    render(next);
  };

  document.getElementById("theme-toggle")?.addEventListener("click", handleToggleClick);
  render(getPreference());

  window.addEventListener("themechange", (event: Event) => {
    const detail = (event as CustomEvent<{ theme?: "light" | "dark"; resolved?: "light" | "dark" }>).detail;
    const theme: "light" | "dark" = detail?.theme ?? getPreference();
    const resolved: "light" | "dark" | undefined = detail?.resolved;
    render(theme, resolved);
  });
</script>
