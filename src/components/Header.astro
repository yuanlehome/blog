---
const BASE = import.meta.env.BASE_URL.endsWith('/') ? import.meta.env.BASE_URL : import.meta.env.BASE_URL + '/';
---
<header class="py-6 border-b border-gray-200 dark:border-gray-800">
    <div class="container mx-auto px-4 flex justify-between items-center max-w-4xl">
        <a href={BASE} class="text-xl font-bold hover:text-blue-600 dark:hover:text-blue-400">Yuanle Liu‚Äòs Blog</a>
        <nav class="flex items-center gap-3">
            <a href={BASE} class="hover:underline">Home</a>
            <a href={`${BASE}archive/`} class="hover:underline">Archive</a>
            <a href={`${BASE}about/`} class="hover:underline">About</a>
            <a href={`${BASE}rss.xml`} class="hover:underline">RSS</a>
            <button id="theme-toggle" class="p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-800" aria-label="Toggle theme">
                üñ•Ô∏è‚òÄÔ∏è
            </button>
        </nav>
    </div>
</header>

<script>
    const storageKey = "theme";
    const order = ["light", "dark", "system"];

    const getPreference = () => {
        try {
            const value = localStorage.getItem(storageKey);
            if (value && order.includes(value)) return value;
        } catch (error) {
            console.warn("Unable to read theme preference:", error);
        }
        return "system";
    };

    const getResolvedTheme = () =>
        document.documentElement.classList.contains("dark") ? "dark" : "light";

    const iconFor = (preference, resolved) => {
        if (preference === "system") return resolved === "dark" ? "üñ•Ô∏èüåô" : "üñ•Ô∏è‚òÄÔ∏è";
        return preference === "dark" ? "üåô" : "‚òÄÔ∏è";
    };

    const labelFor = (preference, resolved) => {
        if (preference === "system") return `System (${resolved})`;
        return preference === "dark" ? "Dark" : "Light";
    };

    const render = (preference, resolvedOverride) => {
        const button = document.getElementById("theme-toggle");
        if (!button) return;
        const resolved = resolvedOverride ?? getResolvedTheme();
        const icon = iconFor(preference, resolved);
        const label = labelFor(preference, resolved);
        button.dataset.theme = preference;
        button.textContent = `${icon} ${label}`;
        button.setAttribute("aria-label", `Toggle theme (current: ${label})`);
    };

    const applyPreference = (preference) => {
        if (typeof window.__setTheme === "function") {
            window.__setTheme(preference);
            return;
        }

        const resolved =
            preference === "dark" ||
            (preference === "system" && window.matchMedia("(prefers-color-scheme: dark)").matches)
                ? "dark"
                : "light";
        document.documentElement.classList.toggle("dark", resolved === "dark");
        try {
            localStorage.setItem(storageKey, preference);
        } catch (error) {
            console.warn("Unable to persist theme preference:", error);
        }
        window.dispatchEvent(new CustomEvent("themechange", { detail: { theme: preference, resolved } }));
    };

    const handleToggleClick = () => {
        const current = getPreference();
        const next = order[(order.indexOf(current) + 1) % order.length];
        applyPreference(next);
        render(next);
    };

    document.getElementById("theme-toggle")?.addEventListener("click", handleToggleClick);
    render(getPreference());

    window.addEventListener("themechange", (event) => {
        const theme = event.detail?.theme ?? getPreference();
        const resolved = event.detail?.resolved;
        render(theme, resolved);
    });
</script>
