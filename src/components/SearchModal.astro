---
const BASE = import.meta.env.BASE_URL.endsWith('/') ? import.meta.env.BASE_URL : import.meta.env.BASE_URL + '/';
---
<div id="search-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 hidden">
  <div class="max-w-3xl mx-auto mt-16 bg-white dark:bg-gray-900 rounded-xl shadow-lg p-6 border border-gray-200 dark:border-gray-800">
    <div class="flex items-center gap-3 mb-4">
      <input
        id="search-input"
        type="search"
        placeholder="Search title, tags, summary..."
        class="w-full rounded-lg border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
      />
      <button id="search-close" class="text-sm px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-800">Close</button>
    </div>
    <div id="search-results" class="space-y-3 max-h-96 overflow-y-auto"></div>
  </div>
</div>

<script>
  const BASE_URL = BASE;
  const modal = document.getElementById('search-modal')!;
  const input = document.getElementById('search-input') as HTMLInputElement | null;
  const closeBtn = document.getElementById('search-close');
  let cache: any[] | null = null;

  const toggle = (open: boolean) => {
    if (!modal) return;
    modal.classList.toggle('hidden', !open);
    document.body.classList.toggle('overflow-hidden', open);
    if (open) {
      input?.focus();
    } else {
      input!.value = '';
      render([]);
    }
  };

  const render = (items: any[]) => {
    const container = document.getElementById('search-results');
    if (!container) return;
    container.innerHTML = '';
    if (items.length === 0) {
      container.innerHTML = '<p class="text-sm text-gray-500">No results</p>';
      return;
    }
    const base = BASE_URL.endsWith('/') ? BASE_URL : BASE_URL + '/';
    items.forEach((item) => {
      const el = document.createElement('a');
      el.href = `${base}${item.slug}/`;
      el.className = 'block p-3 rounded-lg border border-gray-200 dark:border-gray-800 hover:border-blue-500 hover:bg-blue-50/40 dark:hover:bg-gray-800';
      el.innerHTML = `<div class="text-sm text-gray-500">${new Date(item.date).toLocaleDateString()} Â· ${item.tags.join(', ')}</div><div class="font-semibold">${item.title}</div><div class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2">${item.excerpt}</div>`;
      container.appendChild(el);
    });
  };

  const search = (term: string) => {
    if (!cache) return [];
    const needle = term.toLowerCase();
    return cache.filter((item) =>
      `${item.title} ${item.excerpt} ${item.tags.join(' ')}`.toLowerCase().includes(needle)
    ).slice(0, 20);
  };

  const load = async () => {
    if (cache) return cache;
    const resp = await fetch(`${BASE_URL}search-index.json`);
    cache = await resp.json();
    return cache;
  };

  const handleOpen = () => toggle(true);
  const handleClose = () => toggle(false);

  document.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'k') {
      e.preventDefault();
      handleOpen();
    }
    if (e.key === 'Escape') handleClose();
  });

  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    if (target.closest('[data-search-open]')) {
      e.preventDefault();
      handleOpen();
    }
    if (target.id === 'search-modal') handleClose();
  });

  closeBtn?.addEventListener('click', handleClose);

  input?.addEventListener('input', async (e) => {
    const value = (e.target as HTMLInputElement).value.trim();
    await load();
    render(value ? search(value) : []);
  });
</script>
