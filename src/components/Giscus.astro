---
const {
  lang = 'zh-CN',
  loading = 'lazy',
} = Astro.props;
---

<section id="comments" class="mt-12">
  <div class="border-t border-gray-200 dark:border-gray-700 pt-8">
    <script 
      src="https://giscus.app/client.js"
      data-repo="yuanlehome/blog"
      data-repo-id="R_kgDOQu2Jjw"
      data-category="General"
      data-category-id="DIC_kwDOQu2Jj84C0QDN"
      data-mapping="pathname"
      data-strict="0"
      data-reactions-enabled="1"
      data-emit-metadata="0"
      data-input-position="bottom"
      data-theme="preferred_color_scheme"
      data-lang="zh-CN"
      crossorigin="anonymous"
      async
    ></script>
  </div>
</section>

<script is:inline>
  // Mapping uses `pathname` to keep one discussion per URL path, which is stable for static sites.
  const themeMap = {
    light: 'light',
    dark: 'dark_dimmed',
  };

  const getCurrentTheme = () =>
    document.documentElement.classList.contains('dark') ||
    document.documentElement.dataset.theme === 'dark'
      ? 'dark'
      : 'light';

  let activeTheme = getCurrentTheme();

  const postThemeMessage = () => {
    const iframe = document.querySelector('iframe.giscus-frame');
    if (!iframe) return;

    const nextTheme = themeMap[activeTheme] ?? 'light';
    iframe.contentWindow?.postMessage(
      { giscus: { setConfig: { theme: nextTheme } } },
      'https://giscus.app'
    );
  };

  const applyTheme = () => {
    const detected = getCurrentTheme();
    if (detected === activeTheme) return;
    activeTheme = detected;
    postThemeMessage();
  };

  const observer = new MutationObserver(applyTheme);
  observer.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['class', 'data-theme'],
  });

  const ensureFrameAndSync = () => {
    postThemeMessage();
    if (!document.querySelector('iframe.giscus-frame')) {
      requestAnimationFrame(ensureFrameAndSync);
    }
  };

  // Run once after load to sync the initial theme.
  ensureFrameAndSync();
</script>
