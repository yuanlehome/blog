---
import { getReadingTime } from '../lib/content/readingTime';
import { resolveAssetUrl } from '../lib/site/assetUrl';
import { formatDate } from '../lib/content/dates';
import { buildPostUrl, normalizeBase } from '../lib/slug';
import { buildTagIndex } from '../lib/content/tags';
import { getPublishedPosts } from '../lib/content/posts';
import type { CollectionEntry } from 'astro:content';

interface Props {
  posts: CollectionEntry<'blog'>[];
}

const BASE = normalizeBase(import.meta.env.BASE_URL);
const { posts } = Astro.props;

// Build tag index to get slugs
// Note: This builds the tag index for each PostList render. For better performance,
// consider passing tagMap as a prop if this component is rendered frequently.
// Current usage (once per page) makes this acceptable trade-off.
const allPosts = await getPublishedPosts();
const { tagMap } = buildTagIndex(allPosts);

const enriched = posts.map((post) => {
  const postTags = (post.data.tags || []).slice(0, 3); // Max 3 tags
  const remainingCount = (post.data.tags || []).length - 3;

  const tagSlugs = postTags
    .map((tagName) => {
      const entry = Object.entries(tagMap).find(([_, data]) => data.name === tagName);
      return entry ? { name: tagName, slug: entry[0] } : null;
    })
    .filter(Boolean) as { name: string; slug: string }[];

  return {
    ...post,
    stats: getReadingTime(post.body),
    hasCover: Boolean(post.data.cover),
    tagSlugs,
    remainingTagCount: remainingCount > 0 ? remainingCount : 0,
  };
});
---

<ul class="grid gap-6" id="post-list">
  {
    enriched.map((post) => (
      <li class="list-none">
        <a
          href={buildPostUrl(post.slug)}
          class="group relative block overflow-hidden rounded-2xl border border-zinc-200/80 bg-neutral-50/80 px-5 py-5 shadow-[0_10px_30px_rgb(24_24_27/0.04)] transition duration-200 ease-out hover:-translate-y-1 hover:border-sky-200 hover:shadow-[0_14px_36px_rgb(2_132_199/0.1)] active:translate-y-0 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-500 focus-visible:ring-offset-2 motion-reduce:transform-none motion-reduce:shadow-none dark:border-zinc-800/80 dark:bg-zinc-900/70 dark:shadow-[0_16px_38px_rgb(0_0_0/0.4)] dark:hover:border-sky-500/35 dark:hover:shadow-[0_18px_40px_rgb(56_189_248/0.12)] dark:focus-visible:ring-offset-zinc-900"
        >
          <article
            class={`flex flex-col gap-4 ${
              post.hasCover
                ? 'md:grid md:grid-cols-[minmax(0,1fr)_200px] md:items-stretch md:gap-6'
                : ''
            }`}
          >
            <div class={`flex flex-col gap-2 ${post.hasCover ? 'md:h-full md:min-h-full' : ''}`}>
              <h3 class="text-xl font-semibold leading-tight text-zinc-900 transition group-hover:text-sky-600 group-focus-visible:text-sky-600 dark:text-zinc-100 dark:group-hover:text-sky-400 dark:group-focus-visible:text-sky-400">
                <span class="underline-offset-4 decoration-2 decoration-sky-200/0 transition group-hover:underline group-hover:decoration-sky-400/80 group-focus-visible:underline dark:group-hover:decoration-sky-400/60">
                  {post.data.title}
                </span>
              </h3>
              <div class={`flex flex-col gap-2 ${post.hasCover ? 'md:mt-auto' : ''}`}>
                <div class="text-sm text-zinc-600 dark:text-zinc-400">
                  <span class="flex items-center gap-1">üìÖ {formatDate(post.data.date)}</span>
                </div>
                <div class="text-sm text-zinc-500 flex items-center gap-4 flex-wrap">
                  <span class="flex items-center gap-1">‚úçÔ∏è {post.stats.wordCount} Â≠ó</span>
                  <span class="flex items-center gap-1" title={`${post.stats.wordCount} words`}>
                    ‚è±Ô∏è {post.stats.text}
                  </span>
                </div>
                {post.tagSlugs.length > 0 && (
                  <div class="flex flex-wrap gap-1.5 items-center" data-testid="post-list-tags">
                    {post.tagSlugs.map((tag) => (
                      <a
                        href={`${BASE}tags/${tag.slug}/`}
                        class="inline-flex items-center gap-1 rounded-full border text-xs px-2 py-0.5 transition-colors duration-200 font-medium
                          border-sky-200 bg-sky-50 text-sky-700 hover:bg-sky-100 hover:border-sky-300 
                          dark:border-sky-900 dark:bg-sky-950 dark:text-sky-300 dark:hover:bg-sky-900 dark:hover:border-sky-700
                          focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-500"
                        data-tag-slug={tag.slug}
                      >
                        {tag.name}
                      </a>
                    ))}
                    {post.remainingTagCount > 0 && (
                      <span class="text-xs text-zinc-500 dark:text-zinc-400 font-medium">
                        +{post.remainingTagCount}
                      </span>
                    )}
                  </div>
                )}
              </div>
            </div>

            {post.data.cover && (
              <figure class="md:justify-self-end overflow-hidden rounded-xl border border-zinc-200/70 shadow-sm transition duration-200 ease-out group-hover:shadow-md group-hover:border-sky-200 dark:border-zinc-800/70 dark:group-hover:border-sky-400/40 w-full max-w-[320px] md:max-w-[200px] md:min-w-[160px]">
                <img
                  src={resolveAssetUrl(post.data.cover)}
                  alt={post.data.title}
                  loading="lazy"
                  class="aspect-[4/3] w-full object-cover transition duration-300 ease-out motion-safe:group-hover:scale-[1.01] motion-reduce:transform-none"
                />
              </figure>
            )}
          </article>
        </a>
      </li>
    ))
  }
</ul>
