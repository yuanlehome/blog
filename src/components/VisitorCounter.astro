---
interface Props {
  storageKey?: string;
  label?: string;
  increment?: boolean;
}

const storageKey = Astro.props.storageKey ?? 'blog-visitor-count';
const label = Astro.props.label ?? 'è®¿å®¢ç»Ÿè®¡ï¼š';
const increment = Astro.props.increment ?? true;
---

<div
  class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-300"
  data-visitor-container
  data-storage-key={storageKey}
>
  <span aria-hidden="true">ğŸ‘€</span>
  <span>{label}</span>
  <strong data-visitor-count class="tabular-nums">--</strong>
</div>

<script is:inline data-storage-key={storageKey} data-increment={increment}>
  (() => {
    const scriptEl = document.currentScript;
    const storageKey = scriptEl?.dataset.storageKey ?? 'blog-visitor-count';
    const increment = scriptEl?.dataset.increment !== 'false';
    const sessionKey = `${storageKey}-session`;
    const container = scriptEl?.parentElement?.querySelector(
      `[data-visitor-container][data-storage-key="${storageKey}"]`,
    );
    const updateText = (value) => {
      const target = container?.querySelector('[data-visitor-count]');
      if (target) {
        target.textContent = value;
      }
    };

    try {
      const hasCounted = sessionStorage.getItem(sessionKey);
      let total = Number.parseInt(localStorage.getItem(storageKey) ?? '0', 10);

      if (!Number.isFinite(total)) {
        total = 0;
      }

      if (increment && !hasCounted) {
        total += 1;
        sessionStorage.setItem(sessionKey, '1');
        localStorage.setItem(storageKey, total.toString());
      }

      updateText(total.toLocaleString());
    } catch (error) {
      console.error('æ— æ³•è¯»å–è®¿å®¢è®¡æ•°å™¨å­˜å‚¨', error);
      updateText('N/A');
    }
  })();
</script>
