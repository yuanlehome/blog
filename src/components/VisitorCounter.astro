---
interface Props {
  storageKey?: string;
  label?: string;
  increment?: boolean;
  remoteKey?: string;
}

const storageKey = Astro.props.storageKey ?? 'blog-visitor-count';
const label = Astro.props.label ?? 'è®¿å®¢ç»Ÿè®¡ï¼š';
const increment = Astro.props.increment ?? true;
const remoteKey = Astro.props.remoteKey ?? storageKey;
---

<div
  class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-300"
  data-visitor-container
  data-storage-key={storageKey}
>
  <span aria-hidden="true">ğŸ‘€</span>
  <span>{label}</span>
  <strong data-visitor-count class="tabular-nums">--</strong>
</div>

<script
  is:inline
  data-storage-key={storageKey}
  data-increment={increment}
  data-remote-key={remoteKey}
>
  (async () => {
    const scriptEl = document.currentScript;
    const storageKey = scriptEl?.dataset.storageKey ?? 'blog-visitor-count';
    const increment = scriptEl?.dataset.increment !== 'false';
    const remoteKey = scriptEl?.dataset.remoteKey;
    const sessionKey = `${storageKey}-session`;
    const container = document.querySelector(
      `[data-visitor-container][data-storage-key="${storageKey}"]`,
    );
    const updateText = (value) => {
      const target = container?.querySelector('[data-visitor-count]');
      if (target) {
        target.textContent = value;
      }
    };

    try {
      const useRemote = Boolean(remoteKey);
      let remoteSucceeded = false;
      const hasCounted = sessionStorage.getItem(sessionKey);
      const readLocalCount = () => {
        const localValue = Number.parseInt(localStorage.getItem(storageKey) ?? '0', 10);

        if (!Number.isFinite(localValue)) {
          return 0;
        }

        return localValue;
      };

      const shouldIncrement = increment && !hasCounted;
      let total = readLocalCount();

      if (useRemote) {
        try {
          const path = shouldIncrement ? 'hit' : 'get';
          const response = await fetch(
            `https://api.countapi.xyz/${path}/${encodeURIComponent(remoteKey)}`,
          );

          if (!response.ok) {
            throw new Error(`Unexpected status ${response.status}`);
          }

          const data = await response.json();
          const remoteValue = Number.parseInt(String(data?.value ?? data?.data?.value), 10);

          if (!Number.isFinite(remoteValue)) {
            throw new Error('Remote counter returned invalid value');
          }

          total = remoteValue;
          remoteSucceeded = true;
          localStorage.setItem(storageKey, total.toString());

          if (shouldIncrement) {
            sessionStorage.setItem(sessionKey, '1');
          }
        } catch (error) {
          console.warn('è¿œç¨‹è®¿å®¢è®¡æ•°å™¨ä¸å¯ç”¨ï¼Œä½¿ç”¨æœ¬åœ°è®¡æ•°', error);
        }
      }

      const shouldUseLocal = !useRemote || !remoteSucceeded;

      if (shouldUseLocal) {
        total = readLocalCount();

        if (shouldIncrement) {
          total += 1;
          sessionStorage.setItem(sessionKey, '1');
          localStorage.setItem(storageKey, total.toString());
        }
      }

      updateText(Number.isFinite(total) ? total.toLocaleString() : 'N/A');
    } catch (error) {
      console.error('æ— æ³•è¯»å–è®¿å®¢è®¡æ•°å™¨å­˜å‚¨', error);
      updateText('N/A');
    }
  })();
</script>
