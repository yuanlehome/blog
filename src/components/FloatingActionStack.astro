---
import {
  BUTTON_CLASSNAMES,
  BUTTON_ICON_CLASSNAMES,
  STACK_CLASSNAMES,
  buildActions,
} from '../lib/ui/floatingActionStack';

export interface Props {
  enableToc?: boolean;
}

const { enableToc = true } = Astro.props;

const actions = buildActions({ enableToc });
---

{
  actions.length > 0 && (
    <div
      class={`${STACK_CLASSNAMES}`}
      data-floating-action-stack
      style={`inset-inline-end: calc(env(safe-area-inset-right, 0px) + 1rem); inset-block-end: calc(env(safe-area-inset-bottom, 0px) + 1rem);`}
    >
      {actions.map((action, index) => (
        <button
          type="button"
          class={BUTTON_CLASSNAMES}
          data-floating-action-button
          data-action={action.kind}
          data-visible="true"
          style={`transition-delay: ${index * 10}ms;`}
          aria-label={action.ariaLabel}
          {...(action.dataAttributes || {})}
        >
          <span class="sr-only">{action.label}</span>
          <span aria-hidden="true" class={BUTTON_ICON_CLASSNAMES}>
            {action.icon}
          </span>
        </button>
      ))}
    </div>
  )
}

<script>
  const stack = document.querySelector('[data-floating-action-stack]') as HTMLElement | null;
  const tocButton = stack?.querySelector('[data-action="toc"]') as HTMLButtonElement | null;
  const tocRoot = document.querySelector('[data-mobile-toc]') as HTMLElement | null;

  const syncTocState = (open: boolean) => {
    if (!stack) return;
    stack.dataset.tocOpen = open ? 'true' : 'false';
  };

  syncTocState(tocRoot?.dataset.open === 'true');

  tocButton?.addEventListener('click', () => {
    requestAnimationFrame(() => tocButton?.blur());
  });

  window.addEventListener('mobile-toc:toggle', (event: Event) => {
    const detail = (event as CustomEvent<{ open: boolean }>).detail;
    if (!detail) return;
    syncTocState(detail.open);
  });

  if (tocRoot) {
    const observer = new MutationObserver(() => {
      syncTocState(tocRoot.dataset.open === 'true');
    });
    observer.observe(tocRoot, { attributes: true, attributeFilter: ['data-open'] });
  }
</script>
