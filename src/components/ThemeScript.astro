---
const themeInitializer = `(() => {
  const storageKey = 'theme';
  const className = 'dark';
  const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
  const validThemes = ['light', 'dark'];
  let currentPreference = (() => {
    try {
      const stored = localStorage.getItem(storageKey);
      if (stored && validThemes.includes(stored)) return stored;
    } catch (error) {
      console.warn('Unable to access localStorage for theme:', error);
    }
    return mediaQuery.matches ? 'dark' : 'light';
  })();

  const resolveTheme = (preference) => (preference === 'dark' ? 'dark' : 'light');

  const applyTheme = (preference) => {
    const effectiveTheme = resolveTheme(preference);
    document.documentElement.classList.toggle(className, effectiveTheme === 'dark');
    document.documentElement.dataset.theme = effectiveTheme;
    return effectiveTheme;
  };

  const dispatchChange = (preference) => {
    const resolved = document.documentElement.classList.contains(className) ? 'dark' : 'light';
    window.dispatchEvent(
      new CustomEvent('themechange', {
        detail: { theme: preference, resolved },
      }),
    );
  };

  applyTheme(currentPreference);

  window.__setTheme = (next) => {
    const preference = validThemes.includes(String(next)) ? String(next) : resolveTheme(currentPreference);
    currentPreference = preference;
    try {
      localStorage.setItem(storageKey, preference);
    } catch (error) {
      console.warn('Unable to persist theme selection:', error);
    }
    applyTheme(preference);
    dispatchChange(preference);
  };
})();`;
---

<script is:inline set:html={themeInitializer} />
