name: Revert Latest Commit

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to revert latest commit on"
        required: false
        default: "main"
        type: string
      reason:
        description: "Reason (optional, will be included in PR body)"
        required: false
        default: ""
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  revert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Compute latest commit
        id: head
        shell: bash
        run: |
          sha="$(git rev-parse HEAD)"
          msg="$(git log -1 --pretty=%s)"
          echo "sha=$sha" >> "$GITHUB_OUTPUT"
          echo "msg=$msg" >> "$GITHUB_OUTPUT"
          echo "Latest commit: $sha  $msg"

      - name: Revert latest commit (no edit)
        shell: bash
        run: |
          # If it's a merge commit, revert needs -m.
          # Detect parent count: merge commit has 2+ parents.
          parents="$(git rev-list --parents -n 1 HEAD | wc -w)"
          if [[ "$parents" -gt 2 ]]; then
            echo "Detected merge commit. Reverting with -m 1."
            git revert -m 1 --no-edit HEAD
          else
            git revert --no-edit HEAD
          fi

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GH_PAT != '' && secrets.GH_PAT || github.token }}
          base: ${{ inputs.branch }}
          branch: chore/revert-latest
          branch-suffix: timestamp
          commit-message: "[skip ci] revert: latest commit"
          title: "revert: latest commit on ${{ inputs.branch }}"
          body: |
            This PR was auto-generated by the Revert Latest Commit workflow.

            - Target branch: `${{ inputs.branch }}`
            - Reverted commit: `${{ steps.head.outputs.sha }}`
            - Original message: `${{ steps.head.outputs.msg }}`
            - Reason: ${{ inputs.reason }}
            - Run ID: ${{ github.run_id }}
          delete-branch: false
