name: Revert a Commit

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Target branch"
        required: false
        default: "main"
        type: string
      sha:
        description: "Commit SHA to revert (copy from Commits page)"
        required: true
        type: string
      reason:
        description: "Reason (optional)"
        required: false
        default: ""
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  revert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Validate commit exists on branch
        shell: bash
        run: |
          git cat-file -e "${{ inputs.sha }}"^{commit}
          # Ensure it's reachable from the target branch
          git merge-base --is-ancestor "${{ inputs.sha }}" "origin/${{ inputs.branch }}"

      - name: Get commit message
        id: info
        shell: bash
        run: |
          msg="$(git log -1 --pretty=%s ${{ inputs.sha }})"
          echo "msg=$msg" >> "$GITHUB_OUTPUT"
          echo "Reverting: ${{ inputs.sha }}  $msg"

      - name: Revert commit
        shell: bash
        run: |
          # If the target is a merge commit, user must provide mainline parent via input.
          parents="$(git rev-list --parents -n 1 ${{ inputs.sha }} | wc -w)"
          if [[ "$parents" -gt 2 ]]; then
            echo "Target is a merge commit; defaulting to -m 1"
            git revert -m 1 --no-edit "${{ inputs.sha }}"
          else
            git revert --no-edit "${{ inputs.sha }}"
          fi

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GH_PAT != '' && secrets.GH_PAT || github.token }}
          base: ${{ inputs.branch }}
          branch: chore/revert-${{ inputs.sha }}
          branch-suffix: timestamp
          commit-message: "[skip ci] revert: ${{ inputs.sha }}"
          title: "revert: ${{ inputs.sha }} on ${{ inputs.branch }}"
          body: |
            This PR was auto-generated by the Revert a Commit workflow.

            - Target branch: `${{ inputs.branch }}`
            - Reverted commit: `${{ inputs.sha }}`
            - Original message: `${{ steps.info.outputs.msg }}`
            - Reason: ${{ inputs.reason }}
            - Run ID: ${{ github.run_id }}
          delete-branch: false
