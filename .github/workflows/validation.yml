name: Validation

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read

# Prevent concurrent runs for the same PR/branch
concurrency:
  group: validation-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps chromium

      - name: Install Playwright system dependencies (if cached)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium

      - name: Type check
        run: npm run check

      - name: Lint and format check
        run: npm run lint

      - name: Enforce layering rules (Runtime vs Scripts)
        run: npm run depcruise:lint

      - name: Unit tests
        run: npm run test

      - name: Build
        run: npm run build

      - name: E2E tests
        run: npm run test:e2e

  smoke-test:
    runs-on: ubuntu-latest
    needs: validate
    env:
      PORT: '4173'
      BASE_URL: 'http://127.0.0.1:4173'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build (Astro)
        run: npm run build

      - name: Start static server for dist
        shell: bash
        run: |
          set -euo pipefail
          nohup npx --yes http-server dist -p "${PORT}" -a 127.0.0.1 -c-1 > server.log 2>&1 &
          for i in {1..30}; do
            if curl -sS "http://127.0.0.1:${PORT}/" >/dev/null 2>&1; then
              echo "Server is up."
              exit 0
            fi
            sleep 1
          done
          echo "Server failed to start."
          tail -n 200 server.log || true
          exit 1

      - name: Smoke test (HTTP + content assertions)
        shell: bash
        run: |
          set -euo pipefail

          curl_check() {
            local url="$1"
            echo "==> curl ${url}"
            curl -sS -L --fail \
              --retry 10 --retry-delay 2 --retry-all-errors \
              --connect-timeout 10 --max-time 20 \
              "${url}"
          }

          # Detect base prefix
          PREFIX=""
          if [[ -f "dist/blog/index.html" ]]; then
            PREFIX="/blog"
          fi
          echo "Detected PREFIX='${PREFIX}'"

          url_for_dir() {
            local p="$1"
            echo "${BASE_URL}${PREFIX}${p}"
          }
          exists_dir() {
            local p="$1"
            [[ -f "dist${PREFIX}${p}index.html" ]]
          }
          exists_file() {
            local p="$1"
            [[ -f "dist${PREFIX}${p}" ]]
          }

          # Homepage with content assertion
          home_url="${BASE_URL}${PREFIX}/"
          home_html="$(curl_check "${home_url}")"
          grep -q "Recent Posts" <<<"${home_html}"

          # Stable pages
          for p in "/archive/" "/about/"; do
            if exists_dir "${p}"; then
              curl_check "$(url_for_dir "${p}")" > /dev/null
            else
              echo "Skip ${p} (not found in dist)"
            fi
          done

          # RSS
          rss_ok="false"
          if exists_file "/rss.xml"; then
            curl_check "${BASE_URL}${PREFIX}/rss.xml" > /dev/null
            rss_ok="true"
          elif [[ -f "dist/rss.xml" ]]; then
            curl_check "${BASE_URL}/rss.xml" > /dev/null
            rss_ok="true"
          fi
          if [[ "${rss_ok}" != "true" ]]; then
            echo "Skip RSS (rss.xml not found in dist)"
          fi

          # Sitemap
          sitemap_ok="false"
          for sm in "/sitemap.xml" "/sitemap-index.xml"; do
            if [[ -f "dist${PREFIX}${sm}" ]]; then
              curl_check "${BASE_URL}${PREFIX}${sm}" > /dev/null
              echo "${sm} OK (with prefix)"
              sitemap_ok="true"
              break
            elif [[ -f "dist${sm}" ]]; then
              curl_check "${BASE_URL}${sm}" > /dev/null
              echo "${sm} OK (root)"
              sitemap_ok="true"
              break
            fi
          done
          if [[ "${sitemap_ok}" != "true" ]]; then
            echo "No sitemap found in dist"
            exit 1
          fi

          # Article/content page
          article_path="/flashattention/"
          article_url="${BASE_URL}${PREFIX}${article_path}"
          article_ok="false"

          if exists_dir "${article_path}"; then
            article_html="$(curl_check "${article_url}")"
            grep -q "FlashAttention" <<<"${article_html}"
            article_ok="true"
          else
            cand="$(find "dist${PREFIX}" -type f -name "*.html" \
              ! -path "*/index.html" \
              ! -path "*/404.html" \
              ! -path "*/500.html" \
              | head -n 1 || true)"
            if [[ -n "${cand}" ]]; then
              rel="${cand#dist${PREFIX}}"
              article_html="$(curl_check "${BASE_URL}${PREFIX}${rel}")"
              grep -qiE "<html|<article" <<<"${article_html}"
              echo "Picked content page: ${BASE_URL}${PREFIX}${rel}"
              article_ok="true"
            fi
          fi

          if [[ "${article_ok}" != "true" ]]; then
            echo "No stable content page found for assertion."
            exit 1
          fi

          echo "âœ… Smoke test passed."

      - name: Dump server log on failure
        if: failure()
        run: |
          echo "----- server.log (tail) -----"
          tail -n 200 server.log || true
