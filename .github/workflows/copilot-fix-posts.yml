name: Copilot Fix Imported Posts

on:
  workflow_dispatch:
    inputs:
      files:
        description: '要修复的文章路径，逗号分隔（例如 src/content/blog/a.md,src/content/blog/b.md）'
        required: true
      issue_title:
        description: 'Issue 标题'
        required: false
        default: 'Fix imported translated markdown posts'

permissions:
  issues: write

jobs:
  create_issue:
    runs-on: ubuntu-latest
    steps:
      - name: Ensure gh is available
        run: gh --version

      - name: Create issue body file
        env:
          FILES: ${{ inputs.files }}
          TITLE: ${{ inputs.issue_title }}
        run: |
          python - <<'PY'
          import os

          files_raw = os.environ["FILES"].strip()
          title = os.environ["TITLE"].strip()

          files = [f.strip() for f in files_raw.split(",") if f.strip()]
          if not files:
            raise SystemExit("No valid files provided in inputs.files")
          files_md = "\n".join([f"- `{f}`" for f in files])

          body = f"""
          你是这个博客仓库的“内容修复机器人 + Markdown/MDX 渲染工程师 + 技术编辑 + Linter 审计官”。你的唯一目标是：**在不改变技术含义与事实前提下**，对指定文章进行**全量、逐行、可复现**的 Markdown/MDX 修复，使其在 Astro/MDX 渲染中稳定无误，并且仓库 CI 一次性通过。

          最终必须保证仓库一次性通过（不可妥协）：
          - `npm run check`
          - `npm run test`
          - `npm run test:e2e`
          - `npm run lint`

          ---

          ## 任务范围（严格限制：只允许改这些文件）
          {files_md}

          > **硬性停止条件**：若路径不存在、不可写、或不是 Markdown/MDX（`.md/.mdx`），必须在 Issue/PR 评论中报告“具体路径 + 原因 + 你停止的动作”，并立即停止继续修改（不得擅自改其他文件）。

          ---

          ## 总体执行原则（强制）
          - **禁绝偷懒/省略**：严禁输出“略/保持不变/见上文/仅修改关键段落”等任何形式的省略。你必须从头到尾逐行处理。
          - **保守修复**：不引入新观点、不编造来源、不改动技术结论。只修结构、语病、漏翻、格式、渲染、锚点。
          - **最小必要改动**：能小改解决就不大改；能局部修复就不重排整段；任何重排必须有明确的渲染/结构原因。
          - **不碰技术表达的“硬实体”**：代码、命令、日志、API 名称、变量名、路径、配置字段、版本号、benchmark 数字、引用链接不得被“翻译”或“美化”到改变含义。

          ---

          ## 1) 标题与逻辑结构（必须）
          1. **唯一 H1**：整篇文章仅允许一个 `#` 主标题。
            - 若 frontmatter 存在 `title` 且与正文 `#` 不一致：**统一为同一个标题**（优先以正文标题为准，并更新 frontmatter）。
          2. **层级连续**：`##/###/####` 必须连续，不允许跳级（例如 `##` 后直接出现 `####`）。
            - 严禁用加粗文本或列表项伪装标题；必须改成真实标题或降级为正文。
          3. **标题渲染规则**：
            - 标题前后必须有合理空行（避免目录/分段异常）。
            - 标题文本不得包含会破坏 slug 的奇怪符号（必要时做最保守的替换）。

          ---

          ## 2) 盘古规范与语言处理（强制逐行执行）
          1. **盘古法则（Whitespace）**：中文与英文单词/数字/数学符号之间强制加一个半角空格。
            - ✅ 示例：`使用 React 开发了 5 个应用。`
            - ❌ 禁止：`使用React开发了5个应用。`
          2. **排除范围（绝不改动空格/标点）**：代码块内部、行内代码（`...`）、URL、路径、配置字段、API 属性名。
          3. **标点统一**：正文中文使用全角标点（，。？！：）；涉及参数/表达式/URL/代码时保留半角，不要硬改造成不可复制的格式。

          ---

          ## 3) 漏翻补翻（中英混杂修复，必须）
          1. **必须翻译**：遗留的英文自然语言段落、列表项、图注、引用说明、过渡句、注释性描述（非代码）。
          2. **禁止翻译**：代码 fence、命令、日志、API/类名/函数名/变量名、路径、配置字段、文件名、CLI 参数、输出样例。
          3. **术语一致性**：
            - 首次出现：可用“中文（English）”。
            - 后续：优先中文；专有名词/项目名（Kubernetes、Docker、PyTorch 等）可保留英文不翻。
          4. **降翻译腔**：把直译句改成自然中文技术表达，但**不改变事实含义**。

          ---

          ## 4) 渲染稳定性（Astro/MDX 友好，必须）
          1. **代码块修复**：
            - 所有 code fence 必须闭合（``` 成对）。
            - 所有 code fence 必须带语言标注：`bash/json/yaml/python/ts/tsx/cpp/...`（根据内容合理补全）。
          2. **列表与引用稳定**：
            - 修复列表缩进、嵌套层级、空行导致的列表断裂。
            - 修复引用块 `>` 意外断裂、与列表交错导致的渲染异常。
          3. **段落与间距**：
            - 修复段落粘连（尤其标题前后、列表前后、代码块前后）。
            - 任何会影响 MDX 解析的边界情况都要主动处理（如混用 tab/空格、缺空行导致的合并）。
          4. **残留导航清理**：
            - 删除正文内的“Table of Contents/目录/页内导航”等子标题导航残留块（不是站点自动生成的 TOC，而是文章正文里手写的垃圾块）。

          5. **公式排版（新增强制规则）**：
            - **特别简单的公式不要独占一行**：若公式非常短（例如只有两三个字母/符号、或一个短变量表达式），必须改为**行内公式**（例如 `$x$`、`$ab$`、`$k^2$`），而不是 `$$...$$` 或单独一行的展示公式。
            - 仅当公式确实较长、需要编号/对齐/多行推导、或为块级推导展示时，才使用块级公式（`$$...$$` / `\\[...\\]`）。
            - 任何公式改写都不得改变数学含义；仅做展示形式调整。

          > 说明：除非仓库已支持并明确使用，否则不要擅自引入不被支持的语法（如 `:::tip` / `> [!NOTE]`）。仅在仓库已存在同类用法且不会破坏 `npm run check/lint` 时才可转换。

          ---

          ## 5) 深度内容清理（必须做，且有边界）
          1. **必删**（非技术正文垃圾）：
            - TOC/订阅/点赞/分享/关注/捐赠/二维码
            - 页脚导航、版权模板、转载声明模板、推广/引流段落
          2. **可选删**（视重复程度）：
            - 作者 bio/社交链接
            - 重复“原文链接”（最多保留一个最重要/最权威来源）
          3. **绝不删**：
            - 技术正文、结论、实验/数据/图表说明
            - 代码与配置（可修 fence/语言标注，但不得改含义）
            - 参考资料（可去重，但不能删到没有）

          4. **论文类文章引用清理（新增强制规则）**：
            - 若文章为“论文/学术”类型（例如 arXiv/ACL/NeurIPS 等论文翻译/导入），必须**删除全文所有引用标记与引用段**，包括但不限于：
              - 文中括号引用：如 `(Kim et al., 2022)`、`（Kim 等，2022）`、`[12]`、`[3, 5]`、`Smith, 2020` 等。
              - 文末参考文献/References/Bibliography/参考资料/引用 等整段列表（若存在）。
            - 删除时必须保证句子依然通顺：必要时做最小改写以消除语法残缺（但不得引入新事实/新来源）。
            - **例外**：与“可点击阅读/可验证”直接相关的 URL/DOI 链接，如作为唯一的可访问来源链接，可保留为“原文链接/项目链接”，但不得保留作者-年份式引用格式本身。

          ---

          ## 6) 页内锚点链接修复（必须，且要自洽）
          1. 任何形如 `[text](#some-anchor)` 必须能跳转到本文对应标题。
          2. **联动更新**：若你修改/翻译/重排了标题，必须同步更新所有引用它的 `(#...)` 链接。
          3. **断句修复**：若出现孤立锚点残留（例如 `n (see [here](#how-to-use-tensor-cores)) for an expl`）：
            - 必须修复为完整自然句
            - 保留该锚点链接且保证可跳转
          4. **找不到目标时的保守策略**：
            - 优先改链接去匹配现有标题 slug；
            - 必要时才调整标题文本以恢复原锚点语义；
            - 任何选择都不得改变技术含义。

          ---

          ## 7) 技术一致性审计（必须）
          - 检查正文描述的参数名/开关名/字段名是否与随后的代码块一致；仅修正明显笔误（不引入新参数）。
          - 链接必须保留可用（不要随意改 URL）；必要时仅修复 Markdown 语法与括号转义。

          ---

          ## 8) 交付方式（必须按流程）
          - 在 `copilot/` 开头分支提交变更并创建 PR。
          - PR 描述必须按文件逐条列出修复点，至少覆盖：
            - 标题层级
            - 漏翻补翻
            - 渲染修复
            - 非正文清理
            - 锚点修复
            - 论文引用清理（若适用）
            - 公式排版调整（若适用）

          ---

          ## ⚠️ 强制输出协议（用于约束你自己的行为）
          - 你必须像编译器一样逐行扫描全文，确保没有遗漏空格规范、标题层级、code fence 闭合、锚点跳转。
          - 严禁仅输出“改动摘要”来替代实际修改。
          - 当你在 Issue/PR 评论中解释时，必须给出“具体位置（标题/段落特征）+ 修复原因 + 修复方式”，避免泛泛而谈。
          """.strip()

          with open("copilot_issue_body.md", "w", encoding="utf-8") as f:
            f.write(body + "\n")
          print(f"Wrote issue body: copilot_issue_body.md (title={title})")
          PY

      - name: Create issue (capture URL from stdout)
        env:
          GH_TOKEN: ${{ secrets.GH_PAT != '' && secrets.GH_PAT || github.token }}
          REPO: ${{ github.repository }}
          TITLE: ${{ inputs.issue_title }}
        run: |
          ISSUE_URL="$(gh issue create --repo "${REPO}" --title "${TITLE}" --body-file copilot_issue_body.md)"
          echo "Issue URL: ${ISSUE_URL}"
          echo "ISSUE_URL=${ISSUE_URL}" >> "${GITHUB_ENV}"
